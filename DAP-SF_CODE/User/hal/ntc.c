#include "ntc.h"  

//10k   3950K 
//NTC阻值表 -50-- 340°C
const float NTC_TAB[] = 
{
	693.0736, 644.5208, 599.7100, 558.3278, 520.0890,
	484.7341, 452.0267, 421.7511, 393.7107, 367.7258,
	343.6326, 321.2809, 300.5339, 281.2600, 263.3624,
	246.7177, 231.2355, 216.8273, 203.4100, 190.9144,
	179.2666, 168.4000, 158.2726, 148.8151, 139.9837, 
	131.7332, 124.0216, 116.8107, 110.0648, 103.7512, 
	97.8396, 92.3020, 87.1124, 82.2471, 77.6837,
	73.4018, 69.3899, 65.6077, 62.0616, 58.7288, 
	55.5953, 52.6480, 49.8747, 47.2643, 44.8062, 
	42.4906, 40.3086, 38.2516, 36.3117, 34.4817, 
	32.7547, 31.1243, 29.5847, 28.1301, 26.7556, 
	25.4562, 24.2274, 23.0650, 21.9650, 20.9239, 
	19.9380, 19.0041, 18.1193, 17.2807, 16.4857,
	15.7317, 15.0164, 14.3376, 13.6933, 13.0816,
	12.5005, 11.9485, 11.4239, 10.9252, 10.4510,
	10.0000, 9.5709, 9.1626, 8.7738, 8.4037, 
	8.0512, 7.7154, 7.3953, 7.0903, 6.7995,
	6.5221, 6.2576, 6.0051, 5.7624, 5.5342,
	5.3146, 5.1049, 4.9045, 4.7130, 4.5300,
	4.3551, 4.1878, 4.0278, 3.8748, 3.7283, 
	3.5882, 3.4540, 3.3255, 3.2025, 3.0846, 
	2.9717, 2.8635, 2.7597, 2.6603, 2.5649,
	2.4734, 2.3856, 2.3014, 2.2206, 2.1431,
	2.0686, 1.9970, 1.9283, 1.8623, 1.7989, 
	1.7380, 1.6794, 1.6231, 1.5689, 1.5168,
	1.4667, 1.4185, 1.3722, 1.3275, 1.2845,
	1.2431, 1.2033, 1.1649, 1.1279, 1.0923, 
	1.0580, 1.0249, 0.9930, 0.9623, 0.9326,
	0.9040, 0.8764, 0.8498, 0.8241, 0.7994, 
	0.7754, 0.7523, 0.7300, 0.7085, 0.6877, 
	0.6676, 0.6482, 0.6295, 0.6113, 0.5938, 
	0.5769, 0.5605, 0.5447, 0.5293, 0.5145, 
	0.5002, 0.4863, 0.4729, 0.4599, 0.4474,
	0.4352, 0.4234, 0.4120, 0.4009, 0.3902,
	0.3799, 0.3698, 0.3601, 0.3506, 0.3415,
	0.3326, 0.3240, 0.3157, 0.3076, 0.2998, 
	0.2922, 0.2848, 0.2776, 0.2770, 0.2640, 
	0.2574, 0.2511, 0.2449, 0.2389, 0.2331, 
	0.2274, 0.2220, 0.2166, 0.2114, 0.2064, 
	0.2015, 0.1968, 0.1922, 0.1877, 0.1833,
	0.1791, 0.1749, 0.1709, 0.1670, 0.1632, 
	0.1595, 0.1559, 0.1524, 0.1490, 0.1457, 
	0.1425, 0.1394, 0.1363, 0.1333, 0.1304, 
	0.1276, 0.1249, 0.1222, 0.1196, 0.1170, 
	0.1146, 0.1121, 0.1098, 0.1075, 0.1053, 
	0.1031, 0.1010, 0.0989, 0.0969, 0.0949,
	0.0930, 0.0911, 0.0893, 0.0875, 0.0858, 
	0.0841, 0.0824, 0.0808, 0.0791, 0.0777,
	0.0762, 0.0747, 0.0733, 0.0719, 0.0705,
	0.0692, 0.0679, 0.0666, 0.0654, 0.0642, 
	0.0630, 0.0618, 0.0607, 0.0596, 0.0585,
	0.0574, 0.0564, 0.0554, 0.0544, 0.0534, 
	0.0525, 0.0516, 0.0507, 0.0498, 0.0489, 
	0.0481, 0.0473, 0.0464, 0.0456, 0.0449, 
	0.0441, 0.0434, 0.0426, 0.0419, 0.0412, 
	0.0406, 0.0399, 0.0334, 0.0329, 0.0324, 
	0.0319, 0.0314, 0.0309, 0.0304, 0.0300, 
	0.0295, 0.0291, 0.0286, 0.0282, 0.0278, 
	0.0274, 0.0270, 0.0266, 0.0262, 0.0258, 
	0.0255, 0.0251, 0.0247, 0.0244, 0.0240, 
	0.0237, 0.0234, 0.0231, 0.0227, 0.0224, 
	0.0221, 0.0218, 0.0215, 0.0212, 0.0209, 
	0.0207, 0.0204, 0.0201, 0.0198, 0.0196, 
	0.0193, 0.0191, 0.0188, 0.0186, 0.0183, 
	0.0181, 0.0179, 0.0177, 0.0174, 0.0172, 
	0.0170, 0.0168, 0.0166, 0.0164, 0.0162, 
	0.0160, 0.0158, 0.0156, 0.0154, 0.0152, 
	0.0150, 0.0149, 0.0147, 0.0145, 0.0144,
	0.0142, 0.0140, 0.0139, 0.0137, 0.0136, 
	0.0134, 0.0133, 0.0131, 0.0130, 0.0128, 
	0.0127, 0.0125, 0.0124, 0.0123, 0.0121, 
	0.0120, 0.0119, 0.0117, 0.0116, 0.0115, 
	0.0114, 0.0113, 0.0111, 0.0110, 0.0109, 
	0.0108, 0.0107, 0.0106, 0.0105, 0.0104, 
	0.0103, 0.0102, 0.0101, 0.0100, 0.0099,
	0.0098, 0.0097, 0.0096, 0.0095, 0.0094, 
	0.0093, 
};


//10k   3950K 
//NTC阻值表 -40-- 200°C
const float NTC_TAB1[] = 
{
	277.2, 263.6, 250.1, 236.8, 224.0, 
	211.5, 199.6, 188.1, 177.3, 167.0, 
	157.2, 148.1, 139.4, 131.3, 123.7, 
	116.6, 110.0, 103.7, 97.9, 92.50, 
	87.43, 82.79, 78.44, 74.36, 70.53, 
	66.92, 63.54, 60.34, 57.33, 54.50,
	51.82, 49.28, 46.89, 44.62, 42.48, 
	40.45, 38.53, 36.70, 34.97, 33.33, 
	31.77, 30.25, 28.82, 27.45, 26.16, 
	24.94, 23.77, 22.67, 21.62, 20.63, 
	19.68, 18.78, 17.93, 17.12, 16.35, 
	15.62, 14.93, 14.26, 13.63, 13.04, 
	12.47, 11.92, 11.41, 10.91, 10.45, 
	10.00, 9.575, 9.170, 8.784, 8.416, 
	8.064, 7.730, 7.410, 7.106, 6.815, 
	6.538, 6.273, 6.020, 5.778, 5.548, 
	5.327, 5.117, 4.915, 4.723, 4.539, 
	4.363, 4.195, 4.034, 3.880, 3.733, 
	3.592, 3.457, 3.328, 3.204, 3.086, 
	2.972, 2.863, 2.759, 2.659, 2.564, 
	2.472, 2.384, 2.299, 2.218, 2.141, 
	2.066, 1.994, 1.926, 1.860, 1.796, 
	1.735, 1.677, 1.621, 1.567, 1.515, 
	1.465, 1.417, 1.371, 1.326, 1.284, 
	1.243, 1.203, 1.165, 1.128, 1.093, 
	1.059, 1.027, 0.996, 0.965, 0.936, 
	0.908, 0.881, 0.855, 0.830, 0.805, 
	0.782, 0.759, 0.737, 0.715, 0.695, 
	0.674, 0.656, 0.638, 0.620, 0.603, 
	0.586, 0.569, 0.554, 0.538, 0.523, 
	0.508, 0.494, 0.480, 0.467, 0.454, 
	0.441, 0.429, 0.417, 0.406, 0.394, 
	0.384, 0.373, 0.363, 0.353, 0.343, 
	0.334, 0.325, 0.317, 0.308, 0.300,
	0.292, 0.285, 0.277, 0.270, 0.263, 
	0.257, 0.250, 0.244, 0.238, 0.232, 
	0.226, 0.220, 0.215, 0.210, 0.204, 
	0.199, 0.195, 0.190, 0.186, 0.181, 
	0.177, 0.173, 0.169, 0.165, 0.161, 
	0.158, 0.154, 0.151, 0.147, 0.144, 
	0.141, 0.138, 0.135, 0.132, 0.129, 
	0.127, 0.124, 0.121, 0.119, 0.116, 
	0.114, 0.112, 0.109, 0.107, 0.105, 
	0.103, 0.101, 0.099, 0.097, 0.095, 
	0.093, 0.091, 0.089, 0.087, 0.086, 
	0.084, 0.082, 0.081, 0.079, 0.077, 
	0.076, 0.074, 0.073, 0.071, 0.070, 
	0.069, 0.067, 0.066, 0.065, 0.063, 
	0.062,
};


//-40
const float PT100_TAB[] = 
{
	84.27, 84.67, 85.06, 85.46, 85.85,
	86.25, 86.64, 87.04, 87.43, 87.83,
	88.22, 88.62, 89.01, 89.40, 89.80,
	90.19, 90.59, 90.98, 91.37, 91.77,
	92.16, 92.65, 92.95, 93.34, 93.79,
	94.12, 94.52, 94.91, 95.30, 95.69,
	96.09, 96.48, 96.87, 97.26, 97.65,
	98.04, 98.44, 98.83, 99.22, 99.61,
	100.00,100.39,100.78,101.17,101.56,
	101.95,102.34,102.73,103.12,103.51,
	103.90,104.29,104.68,105.07,105.46,
	105.85,106.24,106.63,107.02,107.40,
	107.79,108.81,108.57,108.96,109.35,
	109.73,110.12,110.51,110.90,111.29,
	111.67,112.06,112.45,112.83,113.22,
	113.61,114.00,114.38,114.77,115.15,
	115.54,115.93,116.70,117.08,117.47,
	117.86,118.24,118.63,119.01,119.40,
	119.78,120.17,120.55,120.94,121.32,
	121.71,122.09,122.47,122.86,123.24,
	123.63,124.01,124.39,124.78,125.16,
	125.54,125.93,126.31,126.69,127.08,
	127.46,127.84,128.22,128.61,128.99,
	129.37,129.75,130.13,130.52,130.90,
	131.28,131.66,132.04,132.42,132.80,
	133.18,133.57,133.95,134.33,134.71,
	135.09,135.47,135.85,136.23,136.61,
	136.99,137.37,137.75,138.13,138.51,
	138.88,139.26,139.64,140.02,140.40,
	140.78,141.16,141.54,141.91,142.29,
	142.67,143.05,143.43,143.80,144.18,
	144.56,144.94,145.31,145.69,146.07,
	146.44,146.82,147.20,147.57,147.95,
	148.33,148.70,149.08,149.46,149.83,
	150.21,150.58,150.96,151.33,151.71,
	152.08,152.46,152.83,153.21,153.58,
	153.96,154.33,154.71,155.08,155.46,
	155.83,156.20,156.58,156.95,157.33,
	157.70,158.07,158.45,158.82
};


//*************************************  
// 函数名称：FineTab  二分查找算法 ->查温度表  
// 函数功能：查找数据在表中对应的位置 表中数据从大到小  
// 入口参数：表地址、表长度、要查找的数据  
// 出口参数：无  
// 返 回 值：数据在表中的位置  
//*************************************  
u16 FineTab(const float *a,int TabLong,float data)//表中数据从大到小  
{  
    u16 st=0,ed=TabLong-1,i=0, m = 0; 
    if(data >= a[st]) return st ;  
    else if(data <= a[ed]) return ed ;  
  
    while(st < ed)  
    {  
        m = (st+ed)/2 ;  
  
        if(data == a[m] ) break ;  
        if(data < a[m] && data > a[m+1]) break ;  
          
        if(data > a[m])  ed = m ;                      
        else st = m ;     
          
        if(i++ > TabLong) break ;  
    }  
  
    if(st > ed ) return 0 ;   
  
    return m ;  
}  


//顺序从小到大
u16 FineTab1(const float *a,int TabLong,float data)//表中数据从大到小  
{  
    u16 st=0,ed=TabLong-1,i=0, m = 0; 
    if(data <= a[st]) return st ;  
    else if(data >= a[ed]) return ed ;  
  
    while(st < ed)  
    {  
        m = (st+ed)/2 ;  
  
        if(data == a[m] ) break ;  
        if(data > a[m] && data < a[m+1]) break ;  
          
        if(data < a[m])  ed = m ;                      
        else st = m ;     
          
        if(i++ > TabLong) break ;  
    }  
  
    if(st > ed ) return 0 ;   
  
    return m ;  
}  

//给出通道，根据滤波值算出温度 
s16 get_temperature(u8 channel)
{
	float temp_R,ad_val = 0;
	
	static float val0=0,val1=0,val2=0,val3=0,val4=0,val5=0;
	if(channel == 0)                                //PTC   10K  
	{
		ad_val = (float)(ad1_data[0]*ADC_VERF)/4096.0f;     
		val0 = 0.97f*val0 + 0.03f*ad_val;
        temp_R = val0/((ADC_VERF - val0)/10.0f);  
	}		
	else if(channel == 1)                           //AC Det  交流电压检测
	{ 
		val1 = val1;
	}
	else if(channel == 2)                           //UVLED1 NTC
	{
		ad_val = (float)(ad1_data[2]*ADC_VERF)/4096.0f;
		val2 = 0.97f*val2 + 0.03f*ad_val;
        temp_R = val2/((ADC_VERF - val2)/10.0f); 
	}
	else if(channel == 3)                           //腔体内部温度
	{ 
		ad_val = (float)(ad1_data[3]*ADC_VERF)/4096.0f;
		val3 = 0.97f*val3 + 0.03f*ad_val;
        temp_R = val3/((ADC_VERF - val3)/10.0f);  
	}
	else if(channel == 4)                           //UVLED2 NTC 
	{
		ad_val = (float)(ad1_data[4]*ADC_VERF)/4096.0f;
		val4 = 0.97f*val4 + 0.03f*ad_val;
        temp_R = val4/((ADC_VERF - val4)/10.0f);  
	}
	else if(channel == 5)                       
	{
		ad_val = (float)(ad1_data[5]*ADC_VERF)/4096.0f;
		val5 = 0.97f*val5 + 0.03f*ad_val;
        temp_R = val5/((ADC_VERF - val5)/10.0f); 
	}

	return (FineTab(NTC_TAB,ARRAY_SIZE(NTC_TAB),temp_R) - 50);
}



